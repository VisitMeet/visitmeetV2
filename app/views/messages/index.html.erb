<%= turbo_frame_tag 'chat_window' do %>
  <% other_user = @conversation.sender == current_user ? @conversation.recipient : @conversation.sender %>
  <div class="flex flex-col h-full bg-white dark:bg-gray-800">
    <header class="sticky top-0 z-10 flex items-center gap-3 p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
      <% if other_user.profile_picture.attached? %>
        <%= image_tag other_user.profile_picture.variant(resize_to_fill: [40, 40]), class: "w-10 h-10 rounded-full object-cover" %>
      <% else %>
        <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300 text-sm font-medium">
          <%= other_user.display_name.first.upcase %>
        </div>
      <% end %>
      <h1 class="text-lg font-bold text-gray-900 dark:text-gray-100"><%= other_user.display_name %></h1>
    </header>

    <div id="messages" data-controller="chat-scroll" class="flex-1 overflow-y-auto p-4 space-y-4">
      <%= turbo_stream_from @conversation %>
      <%= turbo_stream_from @conversation, :typing_indicator %>
      <%= render @messages, is_current_user_message: ->(message) { message.user == current_user } %>
      <div id="typing_indicator" class="text-gray-500 dark:text-gray-400 text-sm"><%= render "conversations/typing_indicator", conversation: @conversation %></div>
    </div>

    <footer class="sticky bottom-0 z-10 p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" id="new_message">
      <%= render "form", conversation: @conversation, message: @message %>
    </footer>
  </div>
<% end %>
